<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Linear modeling in EZbakR • EZbakR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Linear modeling in EZbakR">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">EZbakR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Quickstart.html">EZbakR for people in a hurry</a></li>
    <li><a class="dropdown-item" href="../articles/EZget.html">EZget</a></li>
    <li><a class="dropdown-item" href="../articles/EstimateFractions.html">EstimateFractions</a></li>
    <li><a class="dropdown-item" href="../articles/EstimateKinetics.html">EstimateKinetics</a></li>
    <li><a class="dropdown-item" href="../articles/Linear-modeling.html">Linear modeling in EZbakR</a></li>
    <li><a class="dropdown-item" href="../articles/EZDynamics.html">Dynamical systems modeling in EZbakR</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Linear modeling in EZbakR</h1>
            
      

      <div class="d-none name"><code>Linear-modeling.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Typically, you will have multiple replicates of NR-seq data from two
or more “conditions”. In this case, it is common to want to compare
kinetic parameter estimates across the various conditions. In addition,
sometimes you will need to account for complex experimental designs and
potential batch effects. This is the task of generalized linear
modeling, and in this vignette, we will see how to perform this kind of
modeling in EZbakR. EZbakR significantly improves upon its predecessor,
bakR, by allowing users to specify any identifiable design matrix, thus
supporting a wider arrange of comparative analyses than was possible in
bakR.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://isaacvock.github.io/EZbakR/">EZbakR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-scenarios">Example scenarios<a class="anchor" aria-label="anchor" href="#example-scenarios"></a>
</h2>
<p>In this section, I will blaze through some common examples. I will
eventually write later sections to get into some of the details of
linear regression in case you need to more deeply understand how to
generalize beyond what I show in this section. In all cases, the
specification of the linear model that you would like to fit will be
done through the <code>formula_mean</code> argument of EZbakR’s
<code><a href="../reference/AverageAndRegularize.html">AverageAndRegularize()</a></code> function.</p>
<div class="section level3">
<h3 id="the-simplest-case-a-single-condition-factor">The simplest case: a single “condition” factor<a class="anchor" aria-label="anchor" href="#the-simplest-case-a-single-condition-factor"></a>
</h3>
<p>Often, the difference between samples can be described with a single
factor. For example, you may have performed NR-seq in wild-type (WT)
cells, and a variety of knock-out (KO) cell lines. In this, case, there
will likely be a single experimental detail factor in your metadf:</p>
<table class="table">
<thead><tr class="header">
<th align="left">sample</th>
<th align="right">tl</th>
<th align="left">genotype</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sampleA</td>
<td align="right">0</td>
<td align="left">WT</td>
</tr>
<tr class="even">
<td align="left">sampleB</td>
<td align="right">2</td>
<td align="left">WT</td>
</tr>
<tr class="odd">
<td align="left">sampleC</td>
<td align="right">2</td>
<td align="left">WT</td>
</tr>
<tr class="even">
<td align="left">sampleD</td>
<td align="right">0</td>
<td align="left">KO</td>
</tr>
<tr class="odd">
<td align="left">sampleE</td>
<td align="right">2</td>
<td align="left">KO</td>
</tr>
<tr class="even">
<td align="left">sampleF</td>
<td align="right">2</td>
<td align="left">KO</td>
</tr>
</tbody>
</table>
<p>Here, I simulate and then fit the relevant model for both the
log(kdeg)’s as well as the log(ksyn)’s:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">metadf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sampleA"</span>, <span class="st">"sampleB"</span>, <span class="st">"sampleC"</span>,</span>
<span>                            <span class="st">"sampleD"</span>, <span class="st">"sampleE"</span>, <span class="st">"sampleF"</span><span class="op">)</span>,</span>
<span>                 tl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span>,</span>
<span>                        <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                 genotype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"WT"</span>, <span class="st">"WT"</span>,</span>
<span>                               <span class="st">"KO"</span>, <span class="st">"KO"</span>, <span class="st">"KO"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Simulate kdeg and ksyn differences</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">43</span><span class="op">)</span></span>
<span><span class="va">simdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EZSimulate.html">EZSimulate</a></span><span class="op">(</span><span class="fl">500</span>,</span>
<span>                      metadf <span class="op">=</span> <span class="va">metadf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>label_time <span class="op">=</span> <span class="va">tl</span><span class="op">)</span>,</span>
<span>                      mean_formula <span class="op">=</span> <span class="op">~</span><span class="va">genotype</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>                      pdiff_ks <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EZbakRData.html">EZbakRData</a></span><span class="op">(</span><span class="va">simdata</span><span class="op">$</span><span class="va">cB</span>,</span>
<span>                    <span class="va">metadf</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EstimateFractions.html">EstimateFractions</a></span><span class="op">(</span><span class="va">ezbdo</span><span class="op">)</span></span>
<span><span class="co">#&gt; Estimating mutation rates</span></span>
<span><span class="co">#&gt; Summarizing data for feature(s) of interest</span></span>
<span><span class="co">#&gt; Averaging out the nucleotide counts for improved efficiency</span></span>
<span><span class="co">#&gt; Estimating fractions</span></span>
<span><span class="co">#&gt; Processing output</span></span>
<span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EstimateKinetics.html">EstimateKinetics</a></span><span class="op">(</span><span class="va">ezbdo</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Linear modeling in EZbakR:</span></span>
<span></span>
<span><span class="co"># Estimate average log(kdeg) for each genotype</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/AverageAndRegularize.html">AverageAndRegularize</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                              formula_mean <span class="op">=</span> <span class="op">~</span> <span class="va">genotype</span><span class="op">)</span></span>
<span><span class="co">#&gt; Fitting linear model</span></span>
<span><span class="co">#&gt; Estimating coverage vs. variance trend</span></span>
<span><span class="co">#&gt; Regularizing variance estimates</span></span>
<span></span>
<span><span class="co"># Estimate average log(ksyn) for each genotype</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/AverageAndRegularize.html">AverageAndRegularize</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                              parameter <span class="op">=</span> <span class="st">"log_ksyn"</span>,</span>
<span>                              formula_mean <span class="op">=</span> <span class="op">~</span> <span class="va">genotype</span><span class="op">)</span></span>
<span><span class="co">#&gt; Fitting linear model</span></span>
<span><span class="co">#&gt; Estimating coverage vs. variance trend</span></span>
<span><span class="co">#&gt; Regularizing variance estimates</span></span>
<span></span>
<span></span>
<span><span class="co"># Calculate difference in log(kdeg) between the two genotypes</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompareParameters.html">CompareParameters</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                           parameter <span class="op">=</span> <span class="st">"log_kdeg"</span>,</span>
<span>                           design_factor <span class="op">=</span> <span class="st">"genotype"</span>,</span>
<span>                           reference <span class="op">=</span> <span class="st">"WT"</span>,</span>
<span>                           experimental <span class="op">=</span> <span class="st">"KO"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate differe in log(ksyn) between the two genotypes</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompareParameters.html">CompareParameters</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                           parameter <span class="op">=</span> <span class="st">"log_ksyn"</span>,</span>
<span>                           design_factor <span class="op">=</span> <span class="st">"genotype"</span>,</span>
<span>                           reference <span class="op">=</span> <span class="st">"WT"</span>,</span>
<span>                           experimental <span class="op">=</span> <span class="st">"KO"</span><span class="op">)</span></span></code></pre></div>
<p>Everything is default EZbakR stuff discussed in other vignettes until
we get to <code><a href="../reference/AverageAndRegularize.html">AverageAndRegularize()</a></code>. There, I am using the
<code>formula_mean</code> parameter to describe how I want to relate the
parameter being averaged to factors in the metadf.
<code>~ genotype</code> means that I want to calculate average values of
the parameter for each value of <code>genotype</code> that appears in
the metadf.</p>
<p><code><a href="../reference/CompareParameters.html">CompareParameters()</a></code> in this case can be used to get
comparisons of the parameter averages in the two genotypes.
<code>design_factor</code> describes the multi-leveled factor you
included in your <code>formula_mean</code> that you would like to
compare two levels of. The difference in parameters is calculated as
<code>experimental</code> - <code>reference</code>. In this case, these
differences will represent log-fold differences in the kdegs and ksyns
(since a difference in logs is a log of a ratio; log(b) - log(a) =
log(b/a)). If you have more than two conditions in your data, nothing
changes in how you would run <code><a href="../reference/AverageAndRegularize.html">AverageAndRegularize()</a></code>, but
you would need to run <code><a href="../reference/CompareParameters.html">CompareParameters()</a></code> for each
comparison you want to make.</p>
<p>You can visualize the comparative analysis results using MA plots or
volcano plots like so:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Assess log(kdeg) differences</span></span>
<span><span class="fu"><a href="../reference/EZVolcanoPlot.html">EZVolcanoPlot</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>              parameter <span class="op">=</span> <span class="st">"log_kdeg"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Linear-modeling_files/figure-html/unnamed-chunk-5-1.png" width="576"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/EZMAPlot.html">EZMAPlot</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>              parameter <span class="op">=</span> <span class="st">"log_kdeg"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Linear-modeling_files/figure-html/unnamed-chunk-5-2.png" width="576"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Assess log(ksyn) differences</span></span>
<span><span class="fu"><a href="../reference/EZVolcanoPlot.html">EZVolcanoPlot</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>              parameter <span class="op">=</span> <span class="st">"log_ksyn"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Linear-modeling_files/figure-html/unnamed-chunk-6-1.png" width="576"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/EZMAPlot.html">EZMAPlot</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>              parameter <span class="op">=</span> <span class="st">"log_ksyn"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Linear-modeling_files/figure-html/unnamed-chunk-6-2.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="dealing-with-multiple-factors-simple-interaction-model">Dealing with multiple factors: simple interaction model<a class="anchor" aria-label="anchor" href="#dealing-with-multiple-factors-simple-interaction-model"></a>
</h3>
<p>What if there is more than one variable you tweak from replicate to
replicate? Maybe you have multiple cell lines with distinct genotypes,
but you also treat these cell lines with a drug in some cases? Your
metadf may look like:</p>
<table class="table">
<thead><tr class="header">
<th align="left">sample</th>
<th align="right">tl</th>
<th align="left">genotype</th>
<th align="left">treatment</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sampleA</td>
<td align="right">0</td>
<td align="left">WT</td>
<td align="left">nodrug</td>
</tr>
<tr class="even">
<td align="left">sampleB</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">nodrug</td>
</tr>
<tr class="odd">
<td align="left">sampleC</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">nodrug</td>
</tr>
<tr class="even">
<td align="left">sampleD</td>
<td align="right">0</td>
<td align="left">WT</td>
<td align="left">drug</td>
</tr>
<tr class="odd">
<td align="left">sampleE</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">drug</td>
</tr>
<tr class="even">
<td align="left">sampleF</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">drug</td>
</tr>
<tr class="odd">
<td align="left">sampleG</td>
<td align="right">0</td>
<td align="left">KO</td>
<td align="left">nodrug</td>
</tr>
<tr class="even">
<td align="left">sampleH</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">nodrug</td>
</tr>
<tr class="odd">
<td align="left">sampleI</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">nodrug</td>
</tr>
<tr class="even">
<td align="left">sampleJ</td>
<td align="right">0</td>
<td align="left">KO</td>
<td align="left">drug</td>
</tr>
<tr class="odd">
<td align="left">sampleK</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">drug</td>
</tr>
<tr class="even">
<td align="left">sampleL</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">drug</td>
</tr>
</tbody>
</table>
<p>The simplest thing to do in this case is to estimate average
parameter values for each unique combination of your two (or more)
factors. This can be done with a simple <code>formula_mean</code> of
<code>~ genotype:treatment</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">metadf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sampleA"</span>, <span class="st">"sampleB"</span>, <span class="st">"sampleC"</span>,</span>
<span>             <span class="st">"sampleD"</span>, <span class="st">"sampleE"</span>, <span class="st">"sampleF"</span>,</span>
<span>             <span class="st">"sampleG"</span>, <span class="st">"sampleH"</span>, <span class="st">"sampleI"</span>,</span>
<span>             <span class="st">"sampleJ"</span>, <span class="st">"sampleK"</span>, <span class="st">"sampleL"</span><span class="op">)</span>,</span>
<span>  tl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span>,</span>
<span>         <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span>,</span>
<span>         <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span>,</span>
<span>         <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  genotype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"WT"</span>, <span class="st">"WT"</span>,</span>
<span>               <span class="st">"WT"</span>, <span class="st">"WT"</span>, <span class="st">"WT"</span>,</span>
<span>               <span class="st">"KO"</span>, <span class="st">"KO"</span>, <span class="st">"KO"</span>,</span>
<span>               <span class="st">"KO"</span>, <span class="st">"KO"</span>, <span class="st">"KO"</span><span class="op">)</span>,</span>
<span>  treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nodrug"</span>, <span class="st">"nodrug"</span>, <span class="st">"nodrug"</span>,</span>
<span>                <span class="st">"drug"</span>, <span class="st">"drug"</span>, <span class="st">"drug"</span>,</span>
<span>                <span class="st">"nodrug"</span>, <span class="st">"nodrug"</span>, <span class="st">"nodrug"</span>,</span>
<span>                <span class="st">"drug"</span>, <span class="st">"drug"</span>, <span class="st">"drug"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Simulate kdeg and ksyn differences</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">43</span><span class="op">)</span></span>
<span><span class="va">simdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EZSimulate.html">EZSimulate</a></span><span class="op">(</span><span class="fl">500</span>,</span>
<span>                      metadf <span class="op">=</span> <span class="va">metadf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>label_time <span class="op">=</span> <span class="va">tl</span><span class="op">)</span>,</span>
<span>                      mean_formula <span class="op">=</span> <span class="op">~</span><span class="va">genotype</span><span class="op">:</span><span class="va">treatment</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>                      pdiff_ks <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EZbakRData.html">EZbakRData</a></span><span class="op">(</span><span class="va">simdata</span><span class="op">$</span><span class="va">cB</span>,</span>
<span>                    <span class="va">metadf</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EstimateFractions.html">EstimateFractions</a></span><span class="op">(</span><span class="va">ezbdo</span><span class="op">)</span></span>
<span><span class="co">#&gt; Estimating mutation rates</span></span>
<span><span class="co">#&gt; Summarizing data for feature(s) of interest</span></span>
<span><span class="co">#&gt; Averaging out the nucleotide counts for improved efficiency</span></span>
<span><span class="co">#&gt; Estimating fractions</span></span>
<span><span class="co">#&gt; Processing output</span></span>
<span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EstimateKinetics.html">EstimateKinetics</a></span><span class="op">(</span><span class="va">ezbdo</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Linear modeling in EZbakR:</span></span>
<span></span>
<span><span class="co"># Estimate average log(kdeg) for each genotype</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/AverageAndRegularize.html">AverageAndRegularize</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                              formula_mean <span class="op">=</span> <span class="op">~</span> <span class="va">genotype</span><span class="op">:</span><span class="va">treatment</span><span class="op">)</span></span>
<span><span class="co">#&gt; Fitting linear model</span></span>
<span><span class="co">#&gt; Estimating coverage vs. variance trend</span></span>
<span><span class="co">#&gt; Regularizing variance estimates</span></span>
<span></span>
<span><span class="co"># Estimate average log(ksyn) for each genotype</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/AverageAndRegularize.html">AverageAndRegularize</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                              parameter <span class="op">=</span> <span class="st">"log_ksyn"</span>,</span>
<span>                              formula_mean <span class="op">=</span> <span class="op">~</span> <span class="va">genotype</span><span class="op">:</span><span class="va">treatment</span><span class="op">)</span></span>
<span><span class="co">#&gt; Fitting linear model</span></span>
<span><span class="co">#&gt; Estimating coverage vs. variance trend</span></span>
<span><span class="co">#&gt; Regularizing variance estimates</span></span>
<span></span>
<span></span>
<span><span class="co"># Calculate difference in log(kdeg) between WT drug and no drug</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompareParameters.html">CompareParameters</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                           parameter <span class="op">=</span> <span class="st">"log_kdeg"</span>,</span>
<span>                           design_factor <span class="op">=</span> <span class="st">""</span>,</span>
<span>                           reference <span class="op">=</span> <span class="st">"genotypeWT:treatmentnodrug"</span>,</span>
<span>                           experimental <span class="op">=</span> <span class="st">"genotypeWT:treatmentdrug"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate difference in log(kdeg) between KO drug and no drug</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompareParameters.html">CompareParameters</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                           parameter <span class="op">=</span> <span class="st">"log_kdeg"</span>,</span>
<span>                           design_factor <span class="op">=</span> <span class="st">""</span>,</span>
<span>                           reference <span class="op">=</span> <span class="st">"genotypeKO:treatmentnodrug"</span>,</span>
<span>                           experimental <span class="op">=</span> <span class="st">"genotypeKO:treatmentdrug"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate difference in log(kdeg) between KO and WT nodrug</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompareParameters.html">CompareParameters</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                           parameter <span class="op">=</span> <span class="st">"log_kdeg"</span>,</span>
<span>                           design_factor <span class="op">=</span> <span class="st">""</span>,</span>
<span>                           reference <span class="op">=</span> <span class="st">"genotypeWT:treatmentnodrug"</span>,</span>
<span>                           experimental <span class="op">=</span> <span class="st">"genotypeKO:treatmentnodrug"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">### You could do same for log_ksyn</span></span></code></pre></div>
<p>The quirk in this case is how to use <code>CompareParameters</code>.
You have to set <code>design_factor</code> to a blank string, and then
list the full parameter names in <code>reference</code> and
<code>experimental</code>. You can see the parameter names by looking at
the metadata for the relevant <code>AverageAndRegularize</code>
object:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ezbdo</span><span class="op">$</span><span class="va">metadata</span><span class="op">$</span><span class="va">averages</span><span class="op">$</span><span class="va">logkdeg_feature</span><span class="op">$</span><span class="va">fit_params</span></span>
<span><span class="co">#&gt; [1] "genotypeKO:treatmentdrug"   "genotypeKO:treatmentnodrug"</span></span>
<span><span class="co">#&gt; [3] "genotypeWT:treatmentdrug"   "genotypeWT:treatmentnodrug"</span></span></code></pre></div>
<p>It’s a bit of a hack, and I hope to have a more intuitive option for
this case in the near future. I’ll note though, that there was an easier
way in this case. This interaction model works just like a single
parameter model with a factor with one level per unique combination of
factors. So you could have defined a metadf that looks like:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">metadf</span><span class="op">$</span><span class="va">condition</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">metadf</span><span class="op">$</span><span class="va">genotype</span>, <span class="va">metadf</span><span class="op">$</span><span class="va">treatment</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">metadf</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">sample</th>
<th align="right">tl</th>
<th align="left">genotype</th>
<th align="left">treatment</th>
<th align="left">condition</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sampleA</td>
<td align="right">0</td>
<td align="left">WT</td>
<td align="left">nodrug</td>
<td align="left">WTnodrug</td>
</tr>
<tr class="even">
<td align="left">sampleB</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">nodrug</td>
<td align="left">WTnodrug</td>
</tr>
<tr class="odd">
<td align="left">sampleC</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">nodrug</td>
<td align="left">WTnodrug</td>
</tr>
<tr class="even">
<td align="left">sampleD</td>
<td align="right">0</td>
<td align="left">WT</td>
<td align="left">drug</td>
<td align="left">WTdrug</td>
</tr>
<tr class="odd">
<td align="left">sampleE</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">drug</td>
<td align="left">WTdrug</td>
</tr>
<tr class="even">
<td align="left">sampleF</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">drug</td>
<td align="left">WTdrug</td>
</tr>
<tr class="odd">
<td align="left">sampleG</td>
<td align="right">0</td>
<td align="left">KO</td>
<td align="left">nodrug</td>
<td align="left">KOnodrug</td>
</tr>
<tr class="even">
<td align="left">sampleH</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">nodrug</td>
<td align="left">KOnodrug</td>
</tr>
<tr class="odd">
<td align="left">sampleI</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">nodrug</td>
<td align="left">KOnodrug</td>
</tr>
<tr class="even">
<td align="left">sampleJ</td>
<td align="right">0</td>
<td align="left">KO</td>
<td align="left">drug</td>
<td align="left">KOdrug</td>
</tr>
<tr class="odd">
<td align="left">sampleK</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">drug</td>
<td align="left">KOdrug</td>
</tr>
<tr class="even">
<td align="left">sampleL</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">drug</td>
<td align="left">KOdrug</td>
</tr>
</tbody>
</table>
<p>and then set <code>formula_mean</code> in
<code><a href="../reference/AverageAndRegularize.html">AverageAndRegularize()</a></code> to <code>~condition</code>. This
hack comes from the <a href="https://www.bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#interactions" class="external-link">DESeq2
documentation</a>, so check that out for an alternate discussion.</p>
</div>
<div class="section level3">
<h3 id="dealing-with-multiple-factors-estimating-an-actual-interaction-term">Dealing with multiple factors: estimating an actual interaction
term<a class="anchor" aria-label="anchor" href="#dealing-with-multiple-factors-estimating-an-actual-interaction-term"></a>
</h3>
<p>Ok, but what if in the two or more factor case you want to specify
and regress out an actual interaction effect? The interpretation of the
parameters in such a model is a bit more complicated, but here’s how you
would fit such a model:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># factor() ensures that WT + nodrug is treated as the reference</span></span>
<span><span class="co"># which probably makes more intuitive sense</span></span>
<span><span class="va">metadf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sampleA"</span>, <span class="st">"sampleB"</span>, <span class="st">"sampleC"</span>,</span>
<span>             <span class="st">"sampleD"</span>, <span class="st">"sampleE"</span>, <span class="st">"sampleF"</span>,</span>
<span>             <span class="st">"sampleG"</span>, <span class="st">"sampleH"</span>, <span class="st">"sampleI"</span>,</span>
<span>             <span class="st">"sampleJ"</span>, <span class="st">"sampleK"</span>, <span class="st">"sampleL"</span><span class="op">)</span>,</span>
<span>  tl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span>,</span>
<span>         <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span>,</span>
<span>         <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span>,</span>
<span>         <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  genotype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"WT"</span>, <span class="st">"WT"</span>,</span>
<span>               <span class="st">"WT"</span>, <span class="st">"WT"</span>, <span class="st">"WT"</span>,</span>
<span>               <span class="st">"KO"</span>, <span class="st">"KO"</span>, <span class="st">"KO"</span>,</span>
<span>               <span class="st">"KO"</span>, <span class="st">"KO"</span>, <span class="st">"KO"</span><span class="op">)</span>,</span>
<span>               levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"KO"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nodrug"</span>, <span class="st">"nodrug"</span>, <span class="st">"nodrug"</span>,</span>
<span>                <span class="st">"drug"</span>, <span class="st">"drug"</span>, <span class="st">"drug"</span>,</span>
<span>                <span class="st">"nodrug"</span>, <span class="st">"nodrug"</span>, <span class="st">"nodrug"</span>,</span>
<span>                <span class="st">"drug"</span>, <span class="st">"drug"</span>, <span class="st">"drug"</span><span class="op">)</span>,</span>
<span>                levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nodrug"</span>, <span class="st">"drug"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Simulate kdeg and ksyn differences</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">43</span><span class="op">)</span></span>
<span><span class="va">simdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EZSimulate.html">EZSimulate</a></span><span class="op">(</span><span class="fl">500</span>,</span>
<span>                      metadf <span class="op">=</span> <span class="va">metadf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>label_time <span class="op">=</span> <span class="va">tl</span><span class="op">)</span>,</span>
<span>                      mean_formula <span class="op">=</span> <span class="op">~</span><span class="va">genotype</span><span class="op">*</span><span class="va">treatment</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>                      pdiff_ks <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EZbakRData.html">EZbakRData</a></span><span class="op">(</span><span class="va">simdata</span><span class="op">$</span><span class="va">cB</span>,</span>
<span>                    <span class="va">metadf</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EstimateFractions.html">EstimateFractions</a></span><span class="op">(</span><span class="va">ezbdo</span><span class="op">)</span></span>
<span><span class="co">#&gt; Estimating mutation rates</span></span>
<span><span class="co">#&gt; Summarizing data for feature(s) of interest</span></span>
<span><span class="co">#&gt; Averaging out the nucleotide counts for improved efficiency</span></span>
<span><span class="co">#&gt; Estimating fractions</span></span>
<span><span class="co">#&gt; Processing output</span></span>
<span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EstimateKinetics.html">EstimateKinetics</a></span><span class="op">(</span><span class="va">ezbdo</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Linear modeling in EZbakR:</span></span>
<span></span>
<span><span class="co"># Estimate average log(kdeg) for each genotype</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/AverageAndRegularize.html">AverageAndRegularize</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                              formula_mean <span class="op">=</span> <span class="op">~</span> <span class="va">genotype</span><span class="op">*</span><span class="va">treatment</span><span class="op">)</span></span>
<span><span class="co">#&gt; Fitting linear model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimating coverage vs. variance trend</span></span>
<span><span class="co">#&gt; Regularizing variance estimates</span></span>
<span></span>
<span><span class="co"># Estimate average log(ksyn) for each genotype</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/AverageAndRegularize.html">AverageAndRegularize</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                              parameter <span class="op">=</span> <span class="st">"log_ksyn"</span>,</span>
<span>                              formula_mean <span class="op">=</span> <span class="op">~</span> <span class="va">genotype</span><span class="op">*</span><span class="va">treatment</span><span class="op">)</span></span>
<span><span class="co">#&gt; Fitting linear model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimating coverage vs. variance trend</span></span>
<span><span class="co">#&gt; Regularizing variance estimates</span></span>
<span></span>
<span></span>
<span><span class="co"># Viewing parameters will be easier in the future</span></span>
<span><span class="va">ezbdo</span><span class="op">$</span><span class="va">metadata</span><span class="op">$</span><span class="va">averages</span><span class="op">$</span><span class="va">logkdeg_feature</span><span class="op">$</span><span class="va">fit_params</span></span>
<span><span class="co">#&gt; [1] "genotypeWT"               "genotypeKO"              </span></span>
<span><span class="co">#&gt; [3] "treatmentdrug"            "genotypeKO:treatmentdrug"</span></span></code></pre></div>
<p>This model is a bit quirky and has the following 4 parameters:</p>
<ol style="list-style-type: decimal">
<li>
<code>genotypeWT</code>: This represents the average WT, nodrug
parameter value.</li>
<li>
<code>genotypeKO</code>: This represents the average KO, nodrug
parameter value.</li>
<li>
<code>treatmentdrug</code>: This represents the average effect of
drug treatment <strong>on just the reference level genotype (WT in this
case)</strong>.</li>
<li>
<code>genotypeKO:treatmentdrug</code>: This is the “interaction
term”, but more intuitively represents the difference in the KO and WT
drug effects.</li>
</ol>
<p>With this in mind, some things you can do with
<code><a href="../reference/CompareParameters.html">CompareParameters()</a></code> includes:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Assess significance of interaction term</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompareParameters.html">CompareParameters</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                           parameter <span class="op">=</span> <span class="st">"log_kdeg"</span>,</span>
<span>                           param_name <span class="op">=</span> <span class="st">"genotypeKO:treatmentdrug"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assess significance of drug effect on WT</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompareParameters.html">CompareParameters</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                           parameter <span class="op">=</span> <span class="st">"log_kdeg"</span>,</span>
<span>                           param_name <span class="op">=</span> <span class="st">"treatmentdrug"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assess difference of WT and KO</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompareParameters.html">CompareParameters</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                           parameter <span class="op">=</span> <span class="st">"log_kdeg"</span>,</span>
<span>                           design_factor <span class="op">=</span> <span class="st">"genotype"</span>,</span>
<span>                           reference <span class="op">=</span> <span class="st">"WT"</span>,</span>
<span>                           experimental <span class="op">=</span> <span class="st">"KO"</span><span class="op">)</span></span></code></pre></div>
<p>Assessing the impact of drug treatment on the non-reference genotype
is currently not possible, but will be through the currently inactive
<code>param_function</code> parameter in
<code><a href="../reference/CompareParameters.html">CompareParameters()</a></code>. This is because this situation is
unique in that you need to assess the sum of three parameters
(<code>genotypeKO</code>, <code>treatmentdrug</code>, and
<code>genotypeKO:treatmentdrug</code>). Alternatively, the drug impact
on KO can be estimated more simply using the model discussed in the last
section.</p>
</div>
<div class="section level3">
<h3 id="regressing-out-potential-batch-effects">Regressing out potential batch effects<a class="anchor" aria-label="anchor" href="#regressing-out-potential-batch-effects"></a>
</h3>
<p>The final common situation to discuss is when you have multiple
factors in your metadf, but some of them represent technical factors
rather than biological ones. These technical factors constitute what are
often called “batches”, which are technical factors that can influence
parameter estimates and thus risk being a confounder in your analyses.
Linear modeling offers a simple strategy for attempting to deal with
this problem. Consider the following metadf:</p>
<table class="table">
<thead><tr class="header">
<th align="left">sample</th>
<th align="right">tl</th>
<th align="left">genotype</th>
<th align="left">batch</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sampleA</td>
<td align="right">0</td>
<td align="left">WT</td>
<td align="left">A</td>
</tr>
<tr class="even">
<td align="left">sampleB</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">A</td>
</tr>
<tr class="odd">
<td align="left">sampleC</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">B</td>
</tr>
<tr class="even">
<td align="left">sampleD</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">A</td>
</tr>
<tr class="odd">
<td align="left">sampleE</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">B</td>
</tr>
<tr class="even">
<td align="left">sampleF</td>
<td align="right">0</td>
<td align="left">KO</td>
<td align="left">A</td>
</tr>
<tr class="odd">
<td align="left">sampleG</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">A</td>
</tr>
<tr class="even">
<td align="left">sampleH</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">B</td>
</tr>
<tr class="odd">
<td align="left">sampleI</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">A</td>
</tr>
<tr class="even">
<td align="left">sampleJ</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">B</td>
</tr>
</tbody>
</table>
<p>There is a technical factor I am calling “batch” that we suspect may
influence our NR-seq data, independent of any biological difference
between the two genotypes. We would like to “regress out” this technical
effect. This can be done by specifying <code>~genotype + batch</code> in
the <code>formula_mean</code> of
<code><a href="../reference/AverageAndRegularize.html">AverageAndRegularize()</a></code>.:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># factor() ensures that WT is treated as the reference</span></span>
<span><span class="co"># which probably makes more intuitive sense</span></span>
<span><span class="va">metadf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sampleA"</span>, </span>
<span>                            <span class="st">"sampleB"</span>, <span class="st">"sampleC"</span>, <span class="st">"sampleD"</span>, <span class="st">"sampleE"</span>,</span>
<span>                            <span class="st">"sampleF"</span>, </span>
<span>                            <span class="st">"sampleG"</span>, <span class="st">"sampleH"</span>, <span class="st">"sampleI"</span>, <span class="st">"sampleJ"</span><span class="op">)</span>,</span>
<span>                 tl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, </span>
<span>                        <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>,</span>
<span>                        <span class="fl">0</span>, </span>
<span>                        <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                 genotype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>,</span>
<span>                              <span class="st">"WT"</span>, <span class="st">"WT"</span>, <span class="st">"WT"</span>, <span class="st">"WT"</span>,</span>
<span>                              <span class="st">"KO"</span>,</span>
<span>                              <span class="st">"KO"</span>, <span class="st">"KO"</span>, <span class="st">"KO"</span>, <span class="st">"KO"</span><span class="op">)</span>,</span>
<span>                              levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"KO"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 batch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, </span>
<span>                           <span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"A"</span>, <span class="st">"B"</span>,</span>
<span>                           <span class="st">"A"</span>, </span>
<span>                           <span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate kdeg and ksyn differences</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">43</span><span class="op">)</span></span>
<span><span class="va">simdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EZSimulate.html">EZSimulate</a></span><span class="op">(</span><span class="fl">500</span>,</span>
<span>                      metadf <span class="op">=</span> <span class="va">metadf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>label_time <span class="op">=</span> <span class="va">tl</span><span class="op">)</span>,</span>
<span>                      mean_formula <span class="op">=</span> <span class="op">~</span><span class="va">genotype</span> <span class="op">+</span> <span class="va">batch</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>                      pdiff_ks <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EZbakRData.html">EZbakRData</a></span><span class="op">(</span><span class="va">simdata</span><span class="op">$</span><span class="va">cB</span>,</span>
<span>                    <span class="va">metadf</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EstimateFractions.html">EstimateFractions</a></span><span class="op">(</span><span class="va">ezbdo</span><span class="op">)</span></span>
<span><span class="co">#&gt; Estimating mutation rates</span></span>
<span><span class="co">#&gt; Summarizing data for feature(s) of interest</span></span>
<span><span class="co">#&gt; Averaging out the nucleotide counts for improved efficiency</span></span>
<span><span class="co">#&gt; Estimating fractions</span></span>
<span><span class="co">#&gt; Processing output</span></span>
<span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EstimateKinetics.html">EstimateKinetics</a></span><span class="op">(</span><span class="va">ezbdo</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Linear modeling in EZbakR:</span></span>
<span></span>
<span><span class="co"># Estimate average log(kdeg) for each genotype</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/AverageAndRegularize.html">AverageAndRegularize</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                              formula_mean <span class="op">=</span> <span class="op">~</span> <span class="va">genotype</span> <span class="op">+</span> <span class="va">batch</span><span class="op">)</span></span>
<span><span class="co">#&gt; Fitting linear model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimating coverage vs. variance trend</span></span>
<span><span class="co">#&gt; Regularizing variance estimates</span></span>
<span></span>
<span><span class="co"># Estimate average log(ksyn) for each genotype</span></span>
<span><span class="va">ezbdo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/AverageAndRegularize.html">AverageAndRegularize</a></span><span class="op">(</span><span class="va">ezbdo</span>,</span>
<span>                              parameter <span class="op">=</span> <span class="st">"log_ksyn"</span>,</span>
<span>                              formula_mean <span class="op">=</span> <span class="op">~</span> <span class="va">genotype</span> <span class="op">+</span> <span class="va">batch</span><span class="op">)</span></span>
<span><span class="co">#&gt; Fitting linear model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimating coverage vs. variance trend</span></span>
<span><span class="co">#&gt; Regularizing variance estimates</span></span>
<span></span>
<span></span>
<span><span class="co"># Viewing parameters will be easier in the future</span></span>
<span><span class="va">ezbdo</span><span class="op">$</span><span class="va">metadata</span><span class="op">$</span><span class="va">averages</span><span class="op">$</span><span class="va">logkdeg_feature</span><span class="op">$</span><span class="va">fit_params</span></span>
<span><span class="co">#&gt; [1] "genotypeWT" "genotypeKO" "batchB"</span></span></code></pre></div>
<p>The three parameters are:</p>
<ol style="list-style-type: decimal">
<li>
<code>genotypeWT</code>: Average WT parameter value, with the batch
averages “regressed out”.</li>
<li>
<code>genotypeKO</code>: Average KO parameter value, with batch
averages regressed out.</li>
<li>
<code>batchB</code>: Average difference between the batches, when
accounting for apparent biological differences between the batches.</li>
</ol>
<p>Unlike in the interaction model (<code>~genotype*treatment</code>),
the parameters <code>genotypeWT</code> and <code>genotypeKO</code> are
no longer simple averages of samples with the relevant factor value.
Rather, they represent an average that accounts for differences between
batches in the same biological conditions.</p>
<p><strong>MAJOR NOTE:</strong> <code><a href="../reference/AverageAndRegularize.html">AverageAndRegularize()</a></code> will
fail with an error if your model is not “identifiable”. That means, if
you don’t have enough independent data points to estimate all parameters
in your desired linear model, EZbakR won’t let you fit said model.
Consider the following metadf, which contains a technical factor “batch”
as in the other examples discussed in this section:</p>
<table class="table">
<thead><tr class="header">
<th align="left">sample</th>
<th align="right">tl</th>
<th align="left">genotype</th>
<th align="left">batch</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sampleA</td>
<td align="right">0</td>
<td align="left">WT</td>
<td align="left">A</td>
</tr>
<tr class="even">
<td align="left">sampleB</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">A</td>
</tr>
<tr class="odd">
<td align="left">sampleC</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">A</td>
</tr>
<tr class="even">
<td align="left">sampleD</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">A</td>
</tr>
<tr class="odd">
<td align="left">sampleE</td>
<td align="right">2</td>
<td align="left">WT</td>
<td align="left">A</td>
</tr>
<tr class="even">
<td align="left">sampleF</td>
<td align="right">0</td>
<td align="left">KO</td>
<td align="left">B</td>
</tr>
<tr class="odd">
<td align="left">sampleG</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">B</td>
</tr>
<tr class="even">
<td align="left">sampleH</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">B</td>
</tr>
<tr class="odd">
<td align="left">sampleI</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">B</td>
</tr>
<tr class="even">
<td align="left">sampleJ</td>
<td align="right">2</td>
<td align="left">KO</td>
<td align="left">B</td>
</tr>
</tbody>
</table>
<p>If you try and fit the model described in this section
(<code>formula_mean = ~genotype + batch</code>), EZbakR will fail with
an error. Why wasn’t it able to fit the same model with this slightly
different metadf? To fit this model, you need to be able to estimate the
impact of “batch” independent of the impact of “genotype”. In this case
though, all batch A’s are instances of “WT” datasets, and all batch B’s
are instances of “KO” datasets. Thus, the model cannot distinguish batch
effects from real biological differences. It would be like me asking you
to solve the equation 5 = x + z for x and z. There are an infinite
number of combinations of x and z that satisfy this equation.</p>
<p><strong>Conclusion:</strong> If you suspect that batch effects could
influence your measurements (e.g., the day a sample was collected on,
who collected the sample, etc.) you need to ensure that these technical
effects are evenly distributed among your various biological conditions.
Don’t process all “WT” datasets on one day and all “KO” on a different
day. Make sure every batch of samples includes all biologically distinct
conditions you are testing.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Isaac Vock.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
